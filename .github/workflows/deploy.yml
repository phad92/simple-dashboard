name: Deploy to IIS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '21'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Angular app
        run: npm run build --configuration production
      
      - name: Deploy to IIS via PowerShell
        shell: powershell
        run: |
          # Create credential object
          $securePassword = ConvertTo-SecureString "${{ secrets.SID_REMOTE_PASSWORD }}" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ("${{ secrets.SID_REMOTE_USER }}", $securePassword)
          
          # Create remote session
          $session = New-PSSession -ComputerName "${{ secrets.SID_REMOTE_HOST }}" -Credential $credential
          
          # Copy files to server
          Copy-Item -Path "dist/dashboard-angular/*" -Destination "C:\inetpub\wwwroot\your-app\" -ToSession $session -Recurse -Force
          
          # Close session
          Remove-PSSession $session
          
          Write-Host "Deployment completed successfully!"