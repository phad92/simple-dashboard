name: Build & Deploy Angular App to IIS (SSH + Password)

on:
  push:
    branches: ["main"]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      REMOTE_PATH: "C:\\projects\\dashboard"
      BACKUP_PATH: "C:\\projects\\dashboard\\backup"
      IIS_SITE_NAME: "ANGULAR-DASHBOARD"

    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # Node setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # Install Angular CLI
      - name: Install Angular CLI
        run: npm install -g @angular/cli

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Build Angular app
      - name: Build Angular
        run: ng build --configuration production

      # Upload build output using SCP
      - name: Upload Angular build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SID_REMOTE_HOST }}
          username: ${{ secrets.SID_REMOTE_USER }}
          password: ${{ secrets.SID_REMOTE_PASSWORD }}

          # For Angular 17+
          source: "dist/*/browser/*"

          # For Angular <=16 (fallback)
          # source: "dist/<your-app-name>/*"

          target: ${{ env.REMOTE_PATH }}

      # Deploy remotely on IIS
      - name: Deploy to IIS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SID_REMOTE_HOST }}
          username: ${{ secrets.SID_REMOTE_USER }}
          password: ${{ secrets.SID_REMOTE_PASSWORD }}
          script: |
            powershell -NoProfile -ExecutionPolicy Bypass -Command "
              Import-Module WebAdministration;

              Write-Host 'Running PowerShell inside SSH session';

              # Ensure paths exist
              if (!(Test-Path '$env:REMOTE_PATH')) {
                  New-Item -ItemType Directory -Path '$env:REMOTE_PATH';
              }
              if (!(Test-Path '$env:BACKUP_PATH')) {
                  New-Item -ItemType Directory -Path '$env:BACKUP_PATH';
              }

              # Backup old deployment
              \$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss';
              \$backup = Join-Path '$env:BACKUP_PATH' \$timestamp;
              if (Test-Path '$env:REMOTE_PATH') {
                  Copy-Item '$env:REMOTE_PATH/*' \$backup -Recurse -ErrorAction SilentlyContinue;
              }

              # Stop IIS site
              Stop-Website -Name '$env:IIS_SITE_NAME';

              # Deploy new files
              Remove-Item '$env:REMOTE_PATH/*' -Recurse -Force -ErrorAction SilentlyContinue;
              Copy-Item 'C:/Users/${{ secrets.SSH_USER }}/dist/*/browser/*' '$env:REMOTE_PATH' -Recurse;

              # Start IIS site
              Start-Website -Name '$env:IIS_SITE_NAME';
            "

